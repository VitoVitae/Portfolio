DROP SCHEMA IF EXISTS colleges CASCADE;
CREATE SCHEMA colleges;
SET SCHEMA 'colleges';


-- region
CREATE table _region
(    code_region varchar(5),
    libelle_region varchar(30),

    constraint _region_pk 
    primary key (code_region)
);

-- departement
CREATE table _departement (
    code_du_departement varchar(3),
    nom_departement varchar(30),
    code_region text,

    constraint _departement_pk 
    Primary key (code_du_departement),
    -- inclut
    constraint _departement_fk_region foreign key 
    (code_region) references _Region (code_region)
);

-- commune
CREATE table _commune(
    code_insee_de_la_commune varchar(5),
    nom_de_la_commune varchar(30),
    code_du_departement varchar(3),

    constraint _commune_pk Primary key(code_insee_de_la_commune),

    -- se_situe
    constraint _commune_fk_departement foreign key
    (code_du_departement) 
    references _departement( code_du_departement)
);

-- quartier_prioritaire
CREATE table _quartier_prioritaire(
    code_quartier_prioritaire varchar(5),
    nom_quartier_prioritaire varchar(30),

      constraint _quartier_prioritaire_pk 
    primary key (code_quartier_prioritaire)
);

-- type
CREATE table _type(
    code_nature varchar(5),
    libelle_nature varchar(30),
    
    constraint _type_pk primary key (code_nature, libelle_nature)
);

create table _academie(
	code_academie integer,
	lib_academie varchar(30),
	
	constraint _academie_pk primary key (code_academie)
);

---------

create table _etablissement(
  uai varchar(5),
  nom_entablissement varchar(30),
  secteur varchar(30),
  code_postal varchar(5),
  latitude real,
  longitude real,
  
  -- foreign keys
  code_academie integer,
  code_nature varchar(5),
  libelle_nature varchar(30),
  --est_localisé_dans
  code_insee_de_la_commune varchar(5),
  
  CONSTRAINT _etablissement_pk PRIMARY KEY (uai),
  
  CONSTRAINT etablissement_fk_academie FOREIGN KEY (code_academie)
      REFERENCES _academie (code_academie),
  CONSTRAINT etablissement_fk_type FOREIGN KEY (code_nature,libelle_nature)
      REFERENCES _type (code_nature,libelle_nature),
  CONSTRAINT etablissement_fk_commune FOREIGN KEY (code_insee_de_la_commune)
      REFERENCES _commune (code_insee_de_la_commune)
);

-- est_a_proximité_de
CREATE table _est_a_proximité_de(
    code_quartier_prioritaire varchar(5),
    uai varchar(5),

    constraint _est_a_proximité_de_pk 
    Primary key(uai),

	constraint _est_a_proximité_de_fk_quartier_prioritaire foreign key(code_quartier_prioritaire) 
    references _quartier_prioritaire(code_quartier_prioritaire),
    
    constraint _est_a_proximité_de_fk_etablissement foreign key(uai) 
    references _etablissement(uai)
);

create table _annee(
  annee_scolaire varchar(10),
  
  constraint _annee_pk primary key (annee_scolaire)
);


create table _caracteristiques_tout_etablissement(
  uai varchar(5),
  annee_scolaire varchar(10),
  effectifs integer,
  ips real,
  ecart_type_de_l_ips real,
  ep varchar(5),
  
  CONSTRAINT _caracteristiques_tout_etablissement_pk PRIMARY KEY (uai, annee_scolaire),
  
  CONSTRAINT _caracteristiques_tout_etablissement_fk_etablissement FOREIGN KEY (uai)
  	REFERENCES _etablissement (uai),
  
  CONSTRAINT _caracteristiques_tout_etablissement_fk_annee FOREIGN KEY (annee_scolaire)
  	REFERENCES _annee (annee_scolaire)
);

create table _caracteristiques_college(
	uai varchar(5),
  	annee_scolaire varchar(10),
  	nbre_eleves_hors_segpa_hors_ulis integer,
  	nbre_eleves_segpa integer,
  	nbre_eleves_ulis integer,
  	
  	CONSTRAINT _caracteristiques_college_pk PRIMARY KEY (uai, annee_scolaire),
  
  	CONSTRAINT _caracteristiques_college_fk_etablissement FOREIGN KEY (uai)
  		REFERENCES _etablissement (uai),
  	
  	CONSTRAINT _caracteristiques_college_fk_annee FOREIGN KEY (annee_scolaire)
  		REFERENCES _annee (annee_scolaire)
);

create table _classe(
	id_classe varchar(5),
	
	CONSTRAINT _classe_pk PRIMARY KEY (id_classe) 
);

-- relation ternaire
create table _caracteristiques_selon_classe(
	uai varchar(5),
	annee_scolaire varchar(10),
	id_classe varchar(5),
	
	nbre_eleves_hors_segpa_hors_ulis_selon_niveau integer,
	nbre_eleves_segpa_selon_niveau integer,
	nbre_eleves_ulis_selon_niveau integer,
	effectif_filles integer,
	effectif_garcons integer,
	
	CONSTRAINT _caracteristiques_selon_classe_pk PRIMARY KEY (uai, annee_scolaire, id_classe),
	
	CONSTRAINT _caracteristiques_selon_classe_fk_etablissement FOREIGN KEY (uai)
  		REFERENCES _etablissement (uai),
  	CONSTRAINT _caracteristiques_selon_classe_fk_annee FOREIGN KEY (annee_scolaire)
  		REFERENCES _annee (annee_scolaire),
  	CONSTRAINT _caracteristiques_selon_classe_fk_classe FOREIGN KEY (id_classe)
  		REFERENCES _classe (id_classe)
  		
);

